<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pool Finder â€” API Diagnostics</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; font-size: 13px; padding: 20px; background: #f8f9fa; color: #212529; }
    h2 { font-size: 15px; margin: 20px 0 8px; color: #0075C9; border-bottom: 2px solid #0075C9; padding-bottom: 4px; }
    pre {
      background: #1e1e1e; color: #d4d4d4; padding: 14px; border-radius: 6px;
      font-size: 11px; overflow-x: auto; white-space: pre-wrap; word-break: break-all;
      max-height: 400px; overflow-y: auto; line-height: 1.6;
    }
    .status { padding: 8px 12px; border-radius: 4px; margin-bottom: 8px; font-weight: 600; }
    .ok   { background: #e6f4ec; color: #1a7f4b; }
    .err  { background: #fdf0ee; color: #c0392b; }
    .info { background: #e8f4fd; color: #005a9e; }
    button {
      background: #0075C9; color: white; border: none; padding: 8px 18px;
      border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; margin-right: 8px;
    }
    button:hover { background: #005a9e; }
    button:disabled { background: #adb5bd; cursor: not-allowed; }
    .section { background: white; border: 1px solid #dee2e6; border-radius: 6px; padding: 16px; margin-bottom: 16px; }
  </style>
</head>
<body>

<h1 style="font-size:18px;margin-bottom:4px">ğŸ” Pool Finder â€” API Diagnostics</h1>
<p style="color:#868e96;margin-bottom:20px">This page tests the Geotab API connection and shows raw data shapes. Load this as an add-in to run diagnostics.</p>

<div class="section">
  <div id="api-status" class="status info">Checking for Geotab api object...</div>
  <button onclick="runAll()" id="run-btn" disabled>Run All Diagnostics</button>
  <button onclick="runTrips()" id="trips-btn" disabled>Pull Sample Trips</button>
</div>

<div class="section">
  <h2>1. Groups (your type + depot groups)</h2>
  <div id="groups-status" class="status info">Waiting...</div>
  <pre id="groups-out">â€”</pre>
</div>

<div class="section">
  <h2>2. Devices (first 10 vehicles with group assignments)</h2>
  <div id="devices-status" class="status info">Waiting...</div>
  <pre id="devices-out">â€”</pre>
</div>

<div class="section">
  <h2>3. Sample Trips (3 trips â€” checking start/stop shape)</h2>
  <div id="trips-status" class="status info">Waiting...</div>
  <pre id="trips-out">â€”</pre>
</div>

<div class="section">
  <h2>4. Trip count per vehicle (first 5 vehicles, last 90 days)</h2>
  <div id="counts-status" class="status info">Waiting...</div>
  <pre id="counts-out">â€”</pre>
</div>

<script>
  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStatus(id, msg, type) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.className = 'status ' + type;
  }
  function setOut(id, data) {
    document.getElementById(id).textContent =
      typeof data === 'string' ? data : JSON.stringify(data, null, 2);
  }

  // â”€â”€ Check api object â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function checkApi() {
    if (typeof api !== 'undefined') {
      setStatus('api-status', 'âœ“ Geotab api object found â€” ready to run diagnostics', 'ok');
      document.getElementById('run-btn').disabled = false;
      document.getElementById('trips-btn').disabled = false;
    } else {
      setStatus('api-status', 'âœ— api object not found â€” make sure this is loaded as a MyGeotab add-in, not opened directly in browser', 'err');
    }
  }

  // â”€â”€ 1. Groups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function runGroups() {
    setStatus('groups-status', 'Fetching groups...', 'info');
    api.call('Get', { typeName: 'Group' },
      function(groups) {
        // Filter to just user-created groups (not built-in system ones)
        const userGroups = groups.filter(g => !g.id.startsWith('GroupCompany'));
        const shaped = groups.map(g => ({
          id:       g.id,
          name:     g.name || '(no name)',
          parent:   g.parent ? g.parent.id : null,
          color:    g.color || null,
          isBuiltIn: g.id.startsWith('Group') && !g.name
        }));
        setStatus('groups-status', `âœ“ ${groups.length} total groups found (${userGroups.length} user-created)`, 'ok');
        setOut('groups-out', shaped);
      },
      function(err) {
        setStatus('groups-status', 'âœ— Error: ' + JSON.stringify(err), 'err');
        setOut('groups-out', err);
      }
    );
  }

  // â”€â”€ 2. Devices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function runDevices() {
    setStatus('devices-status', 'Fetching devices...', 'info');
    api.call('Get', {
      typeName: 'Device',
      resultsLimit: 10
    },
      function(devices) {
        const shaped = devices.map(d => ({
          id:     d.id,
          name:   d.name,
          groups: d.groups ? d.groups.map(g => g.id) : [],
          type:   d.deviceType || null,
        }));
        setStatus('devices-status', `âœ“ ${devices.length} devices returned (showing first 10)`, 'ok');
        setOut('devices-out', shaped);
      },
      function(err) {
        setStatus('devices-status', 'âœ— Error: ' + JSON.stringify(err), 'err');
        setOut('devices-out', err);
      }
    );
  }

  // â”€â”€ 3. Sample trips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function runTrips() {
    setStatus('trips-status', 'Fetching sample trips...', 'info');
    const fromDate = new Date();
    fromDate.setDate(fromDate.getDate() - 90);

    api.call('Get', {
      typeName: 'Trip',
      search: { fromDate: fromDate.toISOString() },
      resultsLimit: 3
    },
      function(trips) {
        setStatus('trips-status', `âœ“ ${trips.length} sample trips returned`, 'ok');
        setOut('trips-out', trips);
      },
      function(err) {
        setStatus('trips-status', 'âœ— Error: ' + JSON.stringify(err), 'err');
        setOut('trips-out', err);
      }
    );
  }

  // â”€â”€ 4. Trip counts per vehicle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function runTripCounts() {
    setStatus('counts-status', 'Fetching device list for trip counts...', 'info');

    api.call('Get', {
      typeName: 'Device',
      resultsLimit: 5
    },
      function(devices) {
        const fromDate = new Date();
        fromDate.setDate(fromDate.getDate() - 90);
        const results = [];
        let done = 0;

        devices.forEach(device => {
          api.call('Get', {
            typeName: 'Trip',
            search: {
              deviceSearch: { id: device.id },
              fromDate: fromDate.toISOString()
            },
            resultsLimit: 1000
          },
            function(trips) {
              results.push({
                vehicle: device.name,
                deviceId: device.id,
                tripCount: trips.length,
                sampleTrip: trips.length > 0 ? {
                  start: trips[0].start,
                  stop:  trips[0].stop,
                  device: trips[0].device
                } : null
              });
              done++;
              if (done === devices.length) {
                setStatus('counts-status', `âœ“ Trip counts for ${devices.length} vehicles`, 'ok');
                setOut('counts-out', results);
              }
            },
            function(err) {
              results.push({ vehicle: device.name, error: err });
              done++;
              if (done === devices.length) {
                setStatus('counts-status', 'âš  Done with some errors', 'err');
                setOut('counts-out', results);
              }
            }
          );
        });
      },
      function(err) {
        setStatus('counts-status', 'âœ— Error fetching devices: ' + JSON.stringify(err), 'err');
      }
    );
  }

  // â”€â”€ Run all â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function runAll() {
    runGroups();
    runDevices();
    runTrips();
    runTripCounts();
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Wait a tick for MyGeotab to inject the api object
  setTimeout(checkApi, 500);
</script>
</body>
</html>
