<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pool Finder</title>
  <style>
    /* ─────────────────────────────────────────────────────────────────
       ALL STYLES SCOPED UNDER .pf-root
       MyGeotab injects inline add-ins directly into its own DOM, so
       `body` styles are ignored and Geotab's CSS wins.
       Scoping every rule under .pf-root + using !important on layout-
       critical properties gives us full isolation.
    ───────────────────────────────────────────────────────────────── */

    /* Box-sizing reset — scoped, not global */
    .pf-root *, .pf-root *::before, .pf-root *::after {
      box-sizing: border-box !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    /* ── Tokens ── */
    .pf-root {
      --pf-blue:      #0075C9;
      --pf-blue-dark: #005a9e;
      --pf-blue-lt:   #e8f4fd;
      --pf-green:     #1a7f4b;
      --pf-green-lt:  #e6f4ec;
      --pf-red:       #c0392b;
      --pf-red-lt:    #fdf0ee;
      --pf-gold:      #b45309;
      --pf-gold-lt:   #fef3c7;
      --pf-gray-50:   #f8f9fa;
      --pf-gray-100:  #f1f3f5;
      --pf-gray-200:  #e9ecef;
      --pf-gray-300:  #dee2e6;
      --pf-gray-500:  #868e96;
      --pf-gray-700:  #495057;
      --pf-gray-900:  #212529;
      --pf-white:     #ffffff;
      --pf-radius:    6px;
      --pf-shadow:    0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
      --pf-shadow-md: 0 4px 12px rgba(0,0,0,0.10);

      /* Base styles for the root container */
      display: block !important;
      background: var(--pf-gray-50) !important;
      color: var(--pf-gray-900) !important;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
      font-size: 14px !important;
      line-height: 1.5 !important;
      max-width: 1200px !important;
      margin: 0 auto !important;
      padding: 24px 20px 60px !important;
    }

    /* ── Header ── */
    .pf-root .app-header {
      display: flex !important;
      align-items: center !important;
      gap: 14px !important;
      padding: 20px 24px !important;
      background: var(--pf-white) !important;
      border-bottom: 3px solid var(--pf-blue) !important;
      border-radius: var(--pf-radius) var(--pf-radius) 0 0 !important;
      box-shadow: var(--pf-shadow) !important;
      margin-bottom: 24px !important;
    }
    .pf-root .app-header .logo {
      width: 40px !important;
      height: 40px !important;
      background: var(--pf-blue) !important;
      border-radius: 8px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      flex-shrink: 0 !important;
    }
    .pf-root .app-header .logo svg {
      fill: white !important;
      width: 22px !important;
      height: 22px !important;
    }
    .pf-root .app-header h1 {
      font-size: 20px !important;
      font-weight: 700 !important;
      color: var(--pf-gray-900) !important;
      letter-spacing: -0.3px !important;
      display: block !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    .pf-root .app-header p {
      font-size: 12px !important;
      color: var(--pf-gray-500) !important;
      margin-top: 2px !important;
      display: block !important;
    }

    /* ── Section ── */
    .pf-root .section {
      margin-bottom: 28px !important;
      display: block !important;
    }
    .pf-root .section-title {
      font-size: 11px !important;
      font-weight: 700 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.08em !important;
      color: var(--pf-gray-500) !important;
      margin-bottom: 12px !important;
      display: flex !important;
      align-items: center !important;
      gap: 8px !important;
    }
    .pf-root .section-title::after {
      content: '' !important;
      flex: 1 !important;
      height: 1px !important;
      background: var(--pf-gray-200) !important;
    }

    /* ── Summary bar ── */
    .pf-root .summary-bar {
      display: grid !important;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important;
      gap: 12px !important;
      margin-bottom: 28px !important;
    }
    .pf-root .stat-card {
      background: var(--pf-white) !important;
      border: 1px solid var(--pf-gray-200) !important;
      border-radius: var(--pf-radius) !important;
      padding: 16px 20px !important;
      box-shadow: var(--pf-shadow) !important;
      display: block !important;
    }
    .pf-root .stat-card .num {
      font-size: 28px !important;
      font-weight: 800 !important;
      color: var(--pf-blue) !important;
      line-height: 1 !important;
      display: block !important;
    }
    .pf-root .stat-card .num.green { color: var(--pf-green) !important; }
    .pf-root .stat-card .num.gold  { color: var(--pf-gold) !important; }
    .pf-root .stat-card .lbl {
      font-size: 11px !important;
      color: var(--pf-gray-500) !important;
      margin-top: 4px !important;
      font-weight: 500 !important;
      display: block !important;
    }

    /* ── Rec cards ── */
    .pf-root .rec-list {
      display: flex !important;
      flex-direction: column !important;
      gap: 16px !important;
    }
    .pf-root .rec-card {
      background: var(--pf-white) !important;
      border: 1px solid var(--pf-gray-200) !important;
      border-left: 4px solid var(--pf-blue) !important;
      border-radius: var(--pf-radius) !important;
      padding: 20px 24px !important;
      box-shadow: var(--pf-shadow) !important;
      display: block !important;
    }
    .pf-root .rec-card.high-value { border-left-color: var(--pf-gold) !important; }
    .pf-root .rec-card.strong     { border-left-color: var(--pf-green) !important; }

    .pf-root .rec-top {
      display: flex !important;
      justify-content: space-between !important;
      align-items: flex-start !important;
      flex-wrap: wrap !important;
      gap: 16px !important;
    }
    .pf-root .rec-badges {
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 6px !important;
      margin-bottom: 8px !important;
    }

    /* ── Badges ── */
    .pf-root .badge {
      display: inline-block !important;
      padding: 2px 8px !important;
      border-radius: 3px !important;
      font-size: 11px !important;
      font-weight: 600 !important;
      letter-spacing: 0.04em !important;
    }
    .pf-root .badge-blue    { background: var(--pf-blue-lt) !important;  color: var(--pf-blue-dark) !important; }
    .pf-root .badge-green   { background: var(--pf-green-lt) !important; color: var(--pf-green) !important; }
    .pf-root .badge-red     { background: var(--pf-red-lt) !important;   color: var(--pf-red) !important; }
    .pf-root .badge-gold    { background: var(--pf-gold-lt) !important;  color: var(--pf-gold) !important; }
    .pf-root .badge-gray    { background: var(--pf-gray-100) !important; color: var(--pf-gray-700) !important; }
    .pf-root .badge-pass    { background: var(--pf-green-lt) !important; color: var(--pf-green) !important; }
    .pf-root .badge-fail    { background: var(--pf-red-lt) !important;   color: var(--pf-red) !important; }
    .pf-root .badge-good    { background: var(--pf-green-lt) !important; color: var(--pf-green) !important; }
    .pf-root .badge-bad     { background: var(--pf-red-lt) !important;   color: var(--pf-red) !important; }
    .pf-root .badge-neutral { background: var(--pf-gray-100) !important; color: var(--pf-gray-700) !important; }

    .pf-root .rec-title {
      font-size: 16px !important;
      font-weight: 700 !important;
      color: var(--pf-gray-900) !important;
      display: block !important;
    }
    .pf-root .rec-meta {
      font-size: 12px !important;
      color: var(--pf-gray-500) !important;
      margin-top: 4px !important;
      display: block !important;
    }
    .pf-root .rec-savings {
      text-align: right !important;
      flex-shrink: 0 !important;
    }
    .pf-root .rec-savings .big {
      font-size: 26px !important;
      font-weight: 800 !important;
      color: var(--pf-green) !important;
      line-height: 1 !important;
      display: block !important;
    }
    .pf-root .rec-savings .sub {
      font-size: 11px !important;
      color: var(--pf-gray-500) !important;
      margin-top: 4px !important;
      display: block !important;
    }
    .pf-root .rec-savings .total {
      font-size: 12px !important;
      font-weight: 600 !important;
      color: var(--pf-gold) !important;
      margin-top: 3px !important;
      display: block !important;
    }

    /* ── Vehicle chips ── */
    .pf-root .chip-row {
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 6px !important;
      margin-top: 14px !important;
    }
    .pf-root .chip {
      padding: 4px 10px !important;
      border-radius: 4px !important;
      font-size: 12px !important;
      font-weight: 500 !important;
      border: 1px solid !important;
      display: inline-block !important;
    }
    .pf-root .chip-keep {
      background: var(--pf-green-lt) !important;
      color: var(--pf-green) !important;
      border-color: #a7d7bc !important;
    }
    .pf-root .chip-elim {
      background: var(--pf-red-lt) !important;
      color: var(--pf-red) !important;
      border-color: #f0b8b2 !important;
      text-decoration: line-through !important;
      opacity: 0.85 !important;
    }

    /* ── Why box ── */
    .pf-root .why-box {
      margin-top: 14px !important;
      background: var(--pf-gray-50) !important;
      border: 1px solid var(--pf-gray-200) !important;
      border-radius: 4px !important;
      padding: 10px 14px !important;
      font-size: 12px !important;
      color: var(--pf-gray-700) !important;
      line-height: 1.7 !important;
      display: block !important;
    }

    /* ── Savings breakdown ── */
    .pf-root .savings-row {
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 24px !important;
      margin-top: 14px !important;
      padding-top: 14px !important;
      border-top: 1px solid var(--pf-gray-200) !important;
    }
    .pf-root .savings-item .val {
      font-size: 18px !important;
      font-weight: 700 !important;
      color: var(--pf-gray-900) !important;
      display: block !important;
    }
    .pf-root .savings-item .lbl {
      font-size: 11px !important;
      color: var(--pf-gray-500) !important;
      display: block !important;
    }

    /* ── Vehicle grid ── */
    .pf-root .vehicle-grid {
      display: grid !important;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
      gap: 12px !important;
    }
    .pf-root .vehicle-card {
      background: var(--pf-white) !important;
      border: 1px solid var(--pf-gray-200) !important;
      border-radius: var(--pf-radius) !important;
      padding: 14px 16px !important;
      box-shadow: var(--pf-shadow) !important;
      display: block !important;
    }
    .pf-root .vehicle-card-top {
      display: flex !important;
      justify-content: space-between !important;
      align-items: flex-start !important;
      margin-bottom: 10px !important;
    }
    .pf-root .vehicle-name {
      font-size: 13px !important;
      font-weight: 700 !important;
      color: var(--pf-gray-900) !important;
      display: block !important;
    }
    .pf-root .vehicle-meta {
      font-size: 11px !important;
      color: var(--pf-gray-500) !important;
      margin-top: 2px !important;
      display: block !important;
    }

    /* ── Heatmap ── */
    .pf-root .heatmap {
      border-collapse: collapse !important;
      width: 100% !important;
    }
    .pf-root .heatmap th {
      font-size: 9px !important;
      font-weight: 600 !important;
      color: var(--pf-gray-500) !important;
      text-align: center !important;
      padding: 2px 1px !important;
      letter-spacing: 0.02em !important;
    }
    .pf-root .heatmap .row-label {
      font-size: 10px !important;
      color: var(--pf-gray-500) !important;
      padding-right: 6px !important;
      white-space: nowrap !important;
      font-weight: 500 !important;
    }
    .pf-root .heatmap td.cell {
      height: 20px !important;
      border: 1px solid var(--pf-gray-100) !important;
      border-radius: 2px !important;
      cursor: default !important;
      position: relative !important;
    }
    .pf-root .heatmap td.cell:hover::after {
      content: attr(data-tip) !important;
      position: absolute !important;
      bottom: 110% !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      background: var(--pf-gray-900) !important;
      color: white !important;
      padding: 3px 7px !important;
      border-radius: 3px !important;
      font-size: 10px !important;
      white-space: nowrap !important;
      z-index: 9999 !important;
      pointer-events: none !important;
    }

    /* ── Pairs table ── */
    .pf-root .data-table {
      width: 100% !important;
      border-collapse: collapse !important;
      background: var(--pf-white) !important;
      border-radius: var(--pf-radius) !important;
      overflow: hidden !important;
      box-shadow: var(--pf-shadow) !important;
    }
    .pf-root .data-table th {
      background: var(--pf-gray-50) !important;
      border-bottom: 2px solid var(--pf-gray-200) !important;
      text-align: left !important;
      padding: 10px 14px !important;
      font-size: 11px !important;
      font-weight: 700 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.06em !important;
      color: var(--pf-gray-500) !important;
    }
    .pf-root .data-table td {
      padding: 9px 14px !important;
      border-bottom: 1px solid var(--pf-gray-100) !important;
      font-size: 13px !important;
      vertical-align: middle !important;
    }
    .pf-root .data-table tr:last-child td { border-bottom: none !important; }
    .pf-root .data-table tr:hover td { background: var(--pf-gray-50) !important; }
    .pf-root .data-table tr.pool-row td:first-child     { border-left: 3px solid var(--pf-green) !important; }
    .pf-root .data-table tr.conflict-row td:first-child { border-left: 3px solid var(--pf-red) !important; }

    .pf-root .bar-wrap {
      display: flex !important;
      align-items: center !important;
      gap: 8px !important;
    }
    .pf-root .bar {
      height: 6px !important;
      border-radius: 3px !important;
      background: var(--pf-gray-200) !important;
      width: 80px !important;
      overflow: hidden !important;
      display: block !important;
    }
    .pf-root .bar-fill {
      height: 100% !important;
      border-radius: 3px !important;
      transition: width 0.3s !important;
      display: block !important;
    }

    /* ── Validation ── */
    .pf-root .val-list {
      display: flex !important;
      flex-direction: column !important;
      gap: 8px !important;
    }
    .pf-root .val-item {
      display: flex !important;
      align-items: center !important;
      gap: 12px !important;
      background: var(--pf-white) !important;
      border: 1px solid var(--pf-gray-200) !important;
      border-radius: var(--pf-radius) !important;
      padding: 10px 14px !important;
      font-size: 13px !important;
    }
    .pf-root .val-item .check {
      font-size: 16px !important;
      flex-shrink: 0 !important;
    }
    .pf-root .val-item .label {
      flex: 1 !important;
      color: var(--pf-gray-700) !important;
    }

    /* ── Log ── */
    .pf-root .log {
      background: var(--pf-gray-900) !important;
      border-radius: var(--pf-radius) !important;
      padding: 16px !important;
      font-family: "Consolas", "Courier New", monospace !important;
      font-size: 11px !important;
      color: #adb5bd !important;
      max-height: 220px !important;
      overflow-y: auto !important;
      line-height: 1.8 !important;
      display: block !important;
    }
    .pf-root .log .ok   { color: #69db7c !important; display: block !important; }
    .pf-root .log .err  { color: #ff6b6b !important; display: block !important; }
    .pf-root .log .info { color: #74c0fc !important; display: block !important; }
    .pf-root .log .warn { color: #ffd43b !important; display: block !important; }

    /* ── Loading overlay ── */
    .pf-root .loading {
      text-align: center !important;
      padding: 60px 20px !important;
      color: var(--pf-gray-500) !important;
      display: block !important;
    }
    .pf-root .spinner {
      width: 32px !important;
      height: 32px !important;
      border: 3px solid var(--pf-gray-200) !important;
      border-top-color: var(--pf-blue) !important;
      border-radius: 50% !important;
      animation: pf-spin 0.8s linear infinite !important;
      margin: 0 auto 16px !important;
      display: block !important;
    }
    @keyframes pf-spin { to { transform: rotate(360deg); } }

    /* ── Responsive ── */
    @media (max-width: 600px) {
      .pf-root { padding: 12px 12px 40px !important; }
      .pf-root .rec-top { flex-direction: column !important; }
      .pf-root .rec-savings { text-align: left !important; }
      .pf-root .summary-bar { grid-template-columns: repeat(2, 1fr) !important; }
    }
  </style>
</head>
<body>
<!-- .pf-root is the isolation wrapper — everything scoped inside it -->
<div class="pf-root">

  <!-- Header -->
  <div class="app-header">
    <div class="logo">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 4H6C4.9 4 4 4.9 4 6v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 11h-2v-4H9l3-5 3 5h-2v4z"/>
      </svg>
    </div>
    <div>
      <h1>Pool Finder</h1>
      <p>Fleet vehicle pool optimizer · Identify underutilized vehicles for consolidation · Savings model: $8–12k/yr operating + $7k capital per vehicle removed</p>
    </div>
  </div>

  <!-- Summary -->
  <div class="section">
    <div class="section-title">Fleet Summary</div>
    <div class="summary-bar">
      <div class="stat-card"><div class="num" id="s-vehicles">—</div><div class="lbl">Vehicles Analyzed</div></div>
      <div class="stat-card"><div class="num" id="s-trips">—</div><div class="lbl">Total Trips</div></div>
      <div class="stat-card"><div class="num" id="s-pairs">—</div><div class="lbl">Complementary Pairs</div></div>
      <div class="stat-card"><div class="num" id="s-groups">—</div><div class="lbl">Pool Opportunities</div></div>
      <div class="stat-card"><div class="num green" id="s-elim">—</div><div class="lbl">Vehicles Eliminable</div></div>
      <div class="stat-card"><div class="num gold" id="s-annual">—</div><div class="lbl">Annual Op Savings</div></div>
      <div class="stat-card"><div class="num gold" id="s-capital">—</div><div class="lbl">Capital Savings (one-time)</div></div>
    </div>
  </div>

  <!-- Recommendations -->
  <div class="section">
    <div class="section-title">Pool Recommendations — Ranked by 3-Year Value</div>
    <div class="rec-list" id="rec-list">
      <div class="loading"><div class="spinner"></div>Analyzing fleet utilization patterns…</div>
    </div>
  </div>

  <!-- Heatmaps -->
  <div class="section">
    <div class="section-title">Utilization Heatmaps — All Vehicles</div>
    <div class="vehicle-grid" id="heatmap-grid"></div>
  </div>

  <!-- Pairs matrix -->
  <div class="section">
    <div class="section-title">Pair Compatibility Matrix</div>
    <div style="overflow-x:auto">
      <table class="data-table">
        <thead>
          <tr>
            <th>Vehicle A</th><th>Vehicle B</th><th>Type</th><th>Location</th><th>Overlap</th><th>Verdict</th>
          </tr>
        </thead>
        <tbody id="pairs-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Validation -->
  <div class="section">
    <div class="section-title">Logic Validation</div>
    <div class="val-list" id="val-list"></div>
  </div>

  <!-- Log -->
  <div class="section">
    <div class="section-title">Debug Log</div>
    <div class="log" id="log"></div>
  </div>

</div><!-- /.pf-root -->

<script>
// ═══════════════════════════════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════════════════════════════
const CFG = {
  windowDays:          90,
  SLOTS_PER_DAY:       24,
  TOTAL_SLOTS:         168,
  maxOverlapPair:      0.20,
  mergeShareThreshold: 0.50,
  requireSameType:     true,
  requireSameLocation: true,
  annualOpMid:         10000,
  capitalPerVehicle:   7000,
};

const DISPLAY_BLOCKS = ['00–04','04–08','08–12','12–16','16–20','20–24'];
const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

// ═══════════════════════════════════════════════════════════════════
// LOGGING
// ═══════════════════════════════════════════════════════════════════
const logEl = document.getElementById('log');
function log(msg, t='info') {
  const d = document.createElement('div');
  d.className = t;
  d.textContent = `› ${msg}`;
  logEl.appendChild(d);
  logEl.scrollTop = logEl.scrollHeight;
}

// ═══════════════════════════════════════════════════════════════════
// TRIP GENERATION  — Geotab shape: { start, stop } ISO strings
// ═══════════════════════════════════════════════════════════════════
function mkTrip(date, sh, eh) {
  const s = new Date(date); s.setHours(sh, 0, 0, 0);
  const e = new Date(date); e.setHours(eh, 0, 0, 0);
  if (e <= s) return null;
  return { start: s.toISOString(), stop: e.toISOString() };
}

function genTrips(fn, days = CFG.windowDays) {
  const out = [], now = new Date();
  for (let i = days; i >= 0; i--) {
    const d = new Date(now);
    d.setDate(d.getDate() - i);
    d.setHours(0, 0, 0, 0);
    fn(d, d.getDay()).forEach(t => { if (t) out.push(t); });
  }
  return out;
}

// ── Patterns ──
const P = {
  vanDaytime:       (d, dow) => (dow >= 1 && dow <= 5) ? [mkTrip(d, 8, 17)]  : [],
  vanDaytime2:      (d, dow) => (dow >= 1 && dow <= 5) ? [mkTrip(d, 8, 17)]  : [],
  vanEvening:       (d, dow) => { if(dow>=1&&dow<=5) return[mkTrip(d,17,21)]; if(dow===6) return[mkTrip(d,9,13)]; return[]; },
  vanNight:         (d, dow) => ([0,1,2,3,4].includes(dow)) ? [mkTrip(d, 21, 24)] : [],
  vanEarlyMorn:     (d, dow) => (dow >= 1 && dow <= 6) ? [mkTrip(d, 4, 8)]   : [],
  pickupMorning:    (d, dow) => (dow >= 1 && dow <= 5) ? [mkTrip(d, 6, 12)]  : [],
  pickupAfternoon:  (d, dow) => (dow >= 1 && dow <= 5) ? [mkTrip(d, 12, 18)] : [],
  sporadic:         (d, dow) => (Math.random() < 0.25) ? [mkTrip(d, 8 + Math.floor(Math.random()*8), 14 + Math.floor(Math.random()*4))] : [],
  depotSouthDay:    (d, dow) => (dow >= 1 && dow <= 5) ? [mkTrip(d, 8, 17)]  : [],
  depotSouthEvening:(d, dow) => (dow >= 1 && dow <= 5) ? [mkTrip(d, 17, 22)] : [],
};

// ═══════════════════════════════════════════════════════════════════
// 10 VEHICLES
// ═══════════════════════════════════════════════════════════════════
const VEHICLES = [
  { id:'V01', name:'Van 01 — Facilities', type:'Van',    dept:'Facilities', location:'Depot North', pattern:P.vanDaytime,       note:'Mon–Fri 08:00–17:00' },
  { id:'V02', name:'Van 02 — Admin',      type:'Van',    dept:'Admin',      location:'Depot North', pattern:P.vanDaytime2,      note:'Mon–Fri 08:00–17:00 (same pattern as V01)' },
  { id:'V03', name:'Van 03 — Events',     type:'Van',    dept:'Events',     location:'Depot North', pattern:P.vanEvening,       note:'Mon–Fri 17:00–21:00 + Sat 09:00–13:00' },
  { id:'V04', name:'Van 04 — Security',   type:'Van',    dept:'Security',   location:'Depot North', pattern:P.vanNight,         note:'Sun–Thu 21:00–24:00' },
  { id:'V07', name:'Van 07 — Ops Early',  type:'Van',    dept:'Ops',        location:'Depot North', pattern:P.vanEarlyMorn,     note:'Mon–Sat 04:00–08:00' },
  { id:'P01', name:'Pickup 01 — Field A', type:'Pickup', dept:'Field A',    location:'Depot North', pattern:P.pickupMorning,    note:'Mon–Fri 06:00–12:00' },
  { id:'P02', name:'Pickup 02 — Field B', type:'Pickup', dept:'Field B',    location:'Depot North', pattern:P.pickupAfternoon,  note:'Mon–Fri 12:00–18:00' },
  { id:'S01', name:'Sedan 01 — HR',       type:'Sedan',  dept:'HR',         location:'Depot North', pattern:P.sporadic,         note:'Sporadic ~25% of days' },
  { id:'V05', name:'Van 05 — Logistics A',type:'Van',    dept:'Logistics A',location:'Depot South', pattern:P.depotSouthDay,    note:'Mon–Fri 08:00–17:00' },
  { id:'V06', name:'Van 06 — Logistics B',type:'Van',    dept:'Logistics B',location:'Depot South', pattern:P.depotSouthEvening,note:'Mon–Fri 17:00–22:00' },
];

// ═══════════════════════════════════════════════════════════════════
// CORE: 1-HOUR UTILIZATION VECTOR (168 slots)
// ═══════════════════════════════════════════════════════════════════
function buildVector(trips, windowDays = CFG.windowDays) {
  const wdc = new Array(7).fill(0), now = new Date();
  for (let i = 0; i <= windowDays; i++) {
    const d = new Date(now); d.setDate(d.getDate() - i); wdc[d.getDay()]++;
  }
  const hits = new Array(CFG.TOTAL_SLOTS).fill(0);
  for (const trip of trips) {
    const ts = new Date(trip.start), te = new Date(trip.stop);
    if (te <= ts) continue;
    const cur = new Date(ts); cur.setMinutes(0, 0, 0);
    while (cur < te) {
      const next = new Date(cur); next.setHours(cur.getHours() + 1);
      if (cur < te && next > ts) {
        const idx = cur.getDay() * CFG.SLOTS_PER_DAY + cur.getHours();
        if (idx >= 0 && idx < CFG.TOTAL_SLOTS) hits[idx]++;
      }
      cur.setHours(cur.getHours() + 1);
    }
  }
  return hits.map((h, i) => {
    const day = Math.floor(i / CFG.SLOTS_PER_DAY);
    return wdc[day] > 0 ? Math.min(1, h / wdc[day]) : 0;
  });
}

// ═══════════════════════════════════════════════════════════════════
// CORE: COSINE OVERLAP
// ═══════════════════════════════════════════════════════════════════
function cosineOverlap(vA, vB) {
  let dot = 0, mA = 0, mB = 0;
  for (let i = 0; i < vA.length; i++) {
    dot += vA[i] * vB[i]; mA += vA[i] * vA[i]; mB += vB[i] * vB[i];
  }
  const d = Math.sqrt(mA) * Math.sqrt(mB);
  return d === 0 ? 0 : dot / d;
}

// ═══════════════════════════════════════════════════════════════════
// CORE: SUM VECTORS
// ═══════════════════════════════════════════════════════════════════
function sumVectors(vecs) {
  return vecs[0].map((_, i) => vecs.reduce((s, v) => s + v[i], 0));
}
function peakOf(sumVec) { return Math.max(...sumVec); }

// ═══════════════════════════════════════════════════════════════════
// CORE: ELIGIBILITY
// ═══════════════════════════════════════════════════════════════════
function pairEligible(vA, vB) {
  if (CFG.requireSameType     && vA.type     !== vB.type)     return false;
  if (CFG.requireSameLocation && vA.location !== vB.location) return false;
  return true;
}

// ═══════════════════════════════════════════════════════════════════
// CORE: SAVINGS
// ═══════════════════════════════════════════════════════════════════
function calcSavings(n) {
  return {
    n,
    annualOp: n * CFG.annualOpMid,
    capital:  n * CFG.capitalPerVehicle,
    total3yr: n * CFG.annualOpMid * 3 + n * CFG.capitalPerVehicle,
  };
}
function fmt(n) { return '$' + Math.round(n).toLocaleString(); }

// ═══════════════════════════════════════════════════════════════════
// ALGORITHM STEP 1: Complementary pairs
// ═══════════════════════════════════════════════════════════════════
function findComplementaryPairs(vehicles, vm) {
  const pairs = [];
  const n = vehicles.length;
  for (let i = 0; i < n; i++) {
    for (let j = i + 1; j < n; j++) {
      const vA = vehicles[i], vB = vehicles[j];
      if (!pairEligible(vA, vB)) continue;
      const ol = cosineOverlap(vm[vA.id], vm[vB.id]);
      if (ol > CFG.maxOverlapPair) continue;
      const sumPeak = peakOf(sumVectors([vm[vA.id], vm[vB.id]]));
      if (sumPeak <= 1.0) {
        pairs.push({ idA: vA.id, idB: vB.id, overlap: ol });
        log(`Pair: ${vA.id} × ${vB.id} — overlap ${(ol*100).toFixed(0)}%, sum peak ${sumPeak.toFixed(2)}`, 'ok');
      } else {
        log(`Pair ${vA.id} × ${vB.id}: overlap OK but sum peak ${sumPeak.toFixed(2)} > 1 — skipped`, 'warn');
      }
    }
  }
  return pairs;
}

// ═══════════════════════════════════════════════════════════════════
// ALGORITHM STEP 2: Grow pairs into maximal cliques (Bron-Kerbosch)
// ═══════════════════════════════════════════════════════════════════
function findCliques(vehicles, pairs) {
  const vById = Object.fromEntries(vehicles.map(v => [v.id, v]));
  const adj = {};
  vehicles.forEach(v => { adj[v.id] = new Set(); });
  pairs.forEach(p => { adj[p.idA].add(p.idB); adj[p.idB].add(p.idA); });

  const candidates = vehicles.filter(v => adj[v.id].size > 0).map(v => v.id);
  const cliques = [];

  function bronKerbosch(R, P, X) {
    if (P.length === 0 && X.length === 0) {
      if (R.length >= 2) cliques.push([...R].sort());
      return;
    }
    const pivot = [...P, ...X].reduce((best, v) => {
      const c = P.filter(u => adj[v].has(u)).length;
      return c > best.c ? { v, c } : best;
    }, { v: null, c: -1 }).v;
    const pivotN = pivot ? adj[pivot] : new Set();
    const toProcess = P.filter(v => !pivotN.has(v));
    for (const v of toProcess) {
      const nb = [...adj[v]];
      bronKerbosch([...R, v], P.filter(u => nb.includes(u)), X.filter(u => nb.includes(u)));
      P = P.filter(u => u !== v);
      X = [...X, v];
    }
  }

  bronKerbosch([], candidates, []);
  return cliques.map(ids => ({ ids, members: ids.map(id => vById[id]) }));
}

// ═══════════════════════════════════════════════════════════════════
// ALGORITHM STEP 3: Merge overlapping cliques
// ═══════════════════════════════════════════════════════════════════
function mergeCliques(cliques, vById) {
  let groups = cliques.map(c => new Set(c.ids));
  let merged = true;
  while (merged) {
    merged = false;
    const next = [];
    for (let i = 0; i < groups.length; i++) {
      let absorbed = false;
      for (let j = 0; j < next.length; j++) {
        const intersection = new Set([...groups[i]].filter(id => next[j].has(id)));
        const union        = new Set([...groups[i], ...next[j]]);
        const shareRatio = intersection.size / union.size;
        if (shareRatio >= CFG.mergeShareThreshold) {
          next[j] = union;
          absorbed = true;
          merged = true;
          log(`Merged cliques — intersection ${intersection.size}/${union.size} (${(shareRatio*100).toFixed(0)}% shared) → group [${[...union].sort().join(',')}]`, 'warn');
          break;
        }
      }
      if (!absorbed) next.push(new Set(groups[i]));
    }
    groups = next;
  }
  return groups.map(idSet => {
    const ids = [...idSet].sort();
    return { ids, members: ids.map(id => vById[id]) };
  });
}

// ═══════════════════════════════════════════════════════════════════
// ALGORITHM STEP 4: Score merged groups
// ═══════════════════════════════════════════════════════════════════
function scoreGroups(groups, vm) {
  const results = [];
  for (const group of groups) {
    const vecs   = group.members.map(v => vm[v.id]);
    const sumVec = sumVectors(vecs);
    const peak   = peakOf(sumVec);
    const needed = Math.ceil(peak);
    const eliminable = group.members.length - needed;
    if (eliminable < 1) {
      log(`Group [${group.ids.join(',')}]: peak=${peak.toFixed(2)}, needed=${needed} — no elimination possible, skipped`, 'warn');
      continue;
    }
    let olSum = 0, olCount = 0;
    for (let i = 0; i < vecs.length; i++) {
      for (let j = i + 1; j < vecs.length; j++) {
        olSum += cosineOverlap(vecs[i], vecs[j]); olCount++;
      }
    }
    const avgOverlap = olCount > 0 ? olSum / olCount : 0;
    const sv = calcSavings(eliminable);
    results.push({ group, sumVec, peak, needed, eliminable, avgOverlap, savings: sv });
    log(`✓ Group [${group.ids.join(',')}]: size=${group.members.length}, peak=${peak.toFixed(2)}, keep=${needed}, remove=${eliminable}`, 'ok');
  }
  results.sort((a, b) => b.savings.total3yr - a.savings.total3yr);
  return results;
}

// ═══════════════════════════════════════════════════════════════════
// RENDER: HEATMAP
// ═══════════════════════════════════════════════════════════════════
function aggregateTo4h(vec1h) {
  const out = [];
  for (let day = 0; day < 7; day++) {
    for (let block = 0; block < 6; block++) {
      let sum = 0;
      for (let h = 0; h < 4; h++) sum += vec1h[day * 24 + block * 4 + h];
      out.push(sum / 4);
    }
  }
  return out;
}

function renderHeatmap(vec1h) {
  const v4 = aggregateTo4h(vec1h);
  const tbl = document.createElement('table'); tbl.className = 'heatmap';
  const hdr = document.createElement('tr');
  const c = document.createElement('th'); c.style.width = '34px'; hdr.appendChild(c);
  DISPLAY_BLOCKS.forEach(b => { const th = document.createElement('th'); th.textContent = b; hdr.appendChild(th); });
  tbl.appendChild(hdr);
  DAYS.forEach((day, di) => {
    const tr = document.createElement('tr');
    const lbl = document.createElement('td'); lbl.className = 'row-label'; lbl.textContent = day; tr.appendChild(lbl);
    for (let b = 0; b < 6; b++) {
      const val = v4[di * 6 + b];
      const td  = document.createElement('td'); td.className = 'cell';
      if (val < 0.05) {
        td.style.background = '#f8f9fa';
      } else if (val < 0.4) {
        td.style.background = `rgba(0,117,201,${(0.15+val*0.5).toFixed(2)})`;
      } else {
        td.style.background = `rgba(0,117,201,${(0.4+val*0.55).toFixed(2)})`;
      }
      td.setAttribute('data-tip', `${day} ${DISPLAY_BLOCKS[b]}: ${(val*100).toFixed(0)}%`);
      tr.appendChild(td);
    }
    tbl.appendChild(tr);
  });
  return tbl;
}

function renderVehicleCard(v, trips, vec) {
  const card = document.createElement('div'); card.className = 'vehicle-card';
  card.innerHTML = `
    <div class="vehicle-card-top">
      <div>
        <div class="vehicle-name">${v.name}</div>
        <div class="vehicle-meta">${v.type} · ${v.dept} · ${v.location}</div>
        <div class="vehicle-meta">${v.note}</div>
      </div>
      <span class="badge badge-gray">${trips.length} trips</span>
    </div>
  `;
  const w = document.createElement('div'); w.className = 'heatmap-wrap'; w.appendChild(renderHeatmap(vec));
  card.appendChild(w);
  return card;
}

// ═══════════════════════════════════════════════════════════════════
// RENDER: RECOMMENDATION CARD
// ═══════════════════════════════════════════════════════════════════
function renderRecCard(result, rank) {
  const { group, eliminable, needed, peak, avgOverlap, savings } = result;
  const size = group.members.length;

  const tier = eliminable >= 3 ? 'high-value' : eliminable >= 2 ? 'strong' : '';
  const topBadge = eliminable >= 3
    ? `<span class="badge badge-gold">★ High Value</span>`
    : eliminable >= 2
    ? `<span class="badge badge-green">Strong Opportunity</span>`
    : `<span class="badge badge-blue">Recommended</span>`;

  const chips = group.members.map((v, i) => {
    const keep = i < needed;
    return `<span class="chip ${keep ? 'chip-keep' : 'chip-elim'}">${keep ? '✓ Keep:' : '✗ Remove:'} ${v.name} (${v.dept})</span>`;
  }).join('');

  const card = document.createElement('div');
  card.className = `rec-card ${tier}`;
  card.innerHTML = `
    <div class="rec-top">
      <div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
          ${topBadge}
          <span class="badge badge-gray">${group.members[0].type} · ${group.members[0].location}</span>
          <span class="badge badge-gray">${size} vehicles → keep ${needed}, remove ${eliminable}</span>
        </div>
        <div class="rec-title">${size} ${group.members[0].type}s form a pool — ${eliminable} can be eliminated</div>
        <div class="rec-meta">
          Avg pairwise overlap: ${(avgOverlap*100).toFixed(0)}% ·
          Peak simultaneous demand: ${peak.toFixed(2)} ·
          Min vehicles needed: ${needed}
        </div>
      </div>
      <div class="rec-savings">
        <div class="big">${fmt(savings.annualOp)}<span style="font-size:13px;color:#868e96">/yr</span></div>
        <div class="sub">+ ${fmt(savings.capital)} one-time capital savings</div>
        <div class="total">3-yr total value: ${fmt(savings.total3yr)}</div>
      </div>
    </div>

    <div class="chip-row">${chips}</div>

    <div class="why-box">
      <strong>Why this works:</strong>
      Summing all ${size} vehicles' hourly demand, the peak never exceeds <strong>${peak.toFixed(2)}</strong>
      simultaneous vehicles. At most <strong>${needed}</strong> vehicle${needed > 1 ? 's are' : ' is'} ever
      needed at the same time — the other <strong>${eliminable}</strong> are safe to remove from the fleet.
      ${eliminable >= 2 ? `<br><strong>Note:</strong> This group was formed by merging cliques that shared vehicles,
      giving a more complete picture than reporting them as separate recommendations.` : ''}
    </div>

    <div class="savings-row">
      <div class="savings-item">
        <div class="val">${fmt(savings.annualOp)}</div>
        <div class="lbl">Annual Op Savings<br><span style="color:#2a3060">$8k–$12k/vehicle/yr</span></div>
      </div>
      <div class="savings-item">
        <div class="val">${fmt(savings.capital)}</div>
        <div class="lbl">Capital Savings<br><span style="color:#2a3060">$7,000/vehicle one-time</span></div>
      </div>
      <div class="savings-item">
        <div class="val">${fmt(savings.total3yr)}</div>
        <div class="lbl">3-Year Total Value</div>
      </div>
      <div class="savings-item">
        <div class="val">${eliminable} of ${size}</div>
        <div class="lbl">Vehicles Removed</div>
      </div>
    </div>
  `;
  return card;
}

// ═══════════════════════════════════════════════════════════════════
// RENDER: PAIRS TABLE ROW
// ═══════════════════════════════════════════════════════════════════
function renderPairRow(vA, vB, elig, ol, isComplementary) {
  const tr = document.createElement('tr');
  const tm = vA.type === vB.type, lm = vA.location === vB.location;
  const barColor = !elig ? '#868e96' : isComplementary ? '#1a7f4b' : ol >= 0.5 ? '#c0392b' : '#0075C9';
  const verdict = !elig
    ? `<span class="badge badge-gray">Ineligible — ${!tm ? 'type' : 'location'} mismatch</span>`
    : isComplementary
    ? `<span class="badge badge-good">✓ Complementary</span>`
    : ol >= 0.5 ? `<span class="badge badge-bad">Conflict</span>`
    : `<span class="badge badge-neutral">Marginal</span>`;
  if (isComplementary) tr.className = 'pool-row';
  else if (elig && ol >= 0.5) tr.className = 'conflict-row';
  tr.innerHTML = `
    <td>${vA.id} — ${vA.dept}</td>
    <td>${vB.id} — ${vB.dept}</td>
    <td><span class="badge ${tm?'badge-pass':'badge-fail'}">${tm?'✓':'✗'} ${vA.type}</span></td>
    <td><span class="badge ${lm?'badge-pass':'badge-fail'}">${lm?'✓ Same':'✗ Diff'}</span></td>
    <td>${elig
      ? `<div class="bar-wrap"><div class="bar"><div class="bar-fill" style="width:${(ol*100).toFixed(1)}%;background:${barColor}"></div></div><span style="color:${barColor};min-width:34px">${(ol*100).toFixed(0)}%</span></div>`
      : '<span style="color:#868e96">—</span>'}</td>
    <td>${verdict}</td>
  `;
  return tr;
}

// ═══════════════════════════════════════════════════════════════════
// VALIDATION SUITE — 11 tests
// ═══════════════════════════════════════════════════════════════════
const TESTS = [
  { desc: 'At least 1 actionable pool recommendation found',
    fn: r => r.length >= 1 },

  { desc: 'Every recommendation has eliminable >= 1',
    fn: r => r.length > 0 && r.every(x => x.eliminable >= 1) },

  { desc: 'No duplicate vehicle appears across separate recommendations (deduplication)',
    fn: r => {
      const seen = new Set();
      for (const rec of r) {
        for (const id of rec.group.ids) {
          if (seen.has(id)) return false;
          seen.add(id);
        }
      }
      return true;
    }
  },

  { desc: 'V01 & V02 are in the SAME group (merged — both daytime vans)',
    fn: r => r.some(x => x.group.ids.includes('V01') && x.group.ids.includes('V02')) },

  { desc: 'V01 & V02 group also contains V03, V04, V07 (full shift coverage merged)',
    fn: r => r.some(x =>
      ['V01','V02','V03','V04','V07'].every(id => x.group.ids.includes(id))
    )
  },

  { desc: 'That merged 5-van group keeps 2 and removes 3 (two daytime vans = peak of 2)',
    fn: r => r.some(x =>
      x.group.ids.includes('V01') && x.group.ids.includes('V02') &&
      x.needed === 2 && x.eliminable === 3
    )
  },

  { desc: 'V05 & V06 appear together in a Depot South group',
    fn: r => r.some(x => x.group.ids.includes('V05') && x.group.ids.includes('V06')) },

  { desc: 'P01 & P02 appear in a pickup pool group',
    fn: r => r.some(x => x.group.ids.includes('P01') && x.group.ids.includes('P02')) },

  { desc: 'S01 (Sedan) never appears in any recommendation',
    fn: r => !r.some(x => x.group.ids.includes('S01')) },

  { desc: 'No group mixes Depot North and Depot South',
    fn: r => !r.some(x => {
      const locs = x.group.members.map(v => v.location);
      return locs.includes('Depot North') && locs.includes('Depot South');
    })
  },

  { desc: 'Results sorted by 3-year savings descending',
    fn: r => r.length < 2 || r[0].savings.total3yr >= r[1].savings.total3yr },
];

// ═══════════════════════════════════════════════════════════════════
// MAIN
// ═══════════════════════════════════════════════════════════════════
function main() {
  log('Pool Finder v5 — starting', 'info');

  const tripMap = {}, vm = {};
  let totalTrips = 0;
  const vById = Object.fromEntries(VEHICLES.map(v => [v.id, v]));

  VEHICLES.forEach(v => {
    const trips = genTrips(v.pattern);
    tripMap[v.id] = trips;
    vm[v.id] = buildVector(trips);
    totalTrips += trips.length;
    log(`${v.id}: ${trips.length} trips built`, 'ok');
  });

  // Heatmaps
  const grid = document.getElementById('heatmap-grid');
  VEHICLES.forEach(v => grid.appendChild(renderVehicleCard(v, tripMap[v.id], vm[v.id])));

  // Step 1: Complementary pairs
  log('--- Step 1: Complementary pairs ---', 'info');
  const pairs = findComplementaryPairs(VEHICLES, vm);
  const pairSet = new Set(pairs.map(p => `${p.idA}+${p.idB}`));
  log(`${pairs.length} complementary pair(s) found`, pairs.length > 0 ? 'ok' : 'err');

  // Pairs matrix
  const tbody = document.getElementById('pairs-body');
  for (let i = 0; i < VEHICLES.length; i++) {
    for (let j = i + 1; j < VEHICLES.length; j++) {
      const vA = VEHICLES[i], vB = VEHICLES[j];
      const elig = pairEligible(vA, vB);
      const ol = elig ? cosineOverlap(vm[vA.id], vm[vB.id]) : 0;
      tbody.appendChild(renderPairRow(vA, vB, elig, ol, pairSet.has(`${vA.id}+${vB.id}`)));
    }
  }

  // Step 2: Clique finding
  log('--- Step 2: Clique finding ---', 'info');
  const cliques = findCliques(VEHICLES, pairs);
  log(`${cliques.length} raw clique(s) found`, cliques.length > 0 ? 'ok' : 'warn');
  cliques.forEach(c => log(`  Clique: [${c.ids.join(', ')}]`, 'info'));

  // Step 3: Merge overlapping cliques
  log('--- Step 3: Merging overlapping cliques ---', 'info');
  const mergedGroups = mergeCliques(cliques, vById);
  log(`${mergedGroups.length} group(s) after merging`, 'ok');
  mergedGroups.forEach(g => log(`  Merged group: [${g.ids.join(', ')}]`, 'info'));

  // Step 4: Score
  log('--- Step 4: Scoring groups ---', 'info');
  const results = scoreGroups(mergedGroups, vm);

  // Render recommendations
  const recList = document.getElementById('rec-list');
  if (!results.length) {
    recList.innerHTML = '<div style="color:#868e96;padding:40px;text-align:center">No actionable pool groups found.</div>';
  } else {
    results.forEach((r, i) => recList.appendChild(renderRecCard(r, i)));
  }

  // Validation
  log('--- Validation ---', 'info');
  const valList = document.getElementById('val-list');
  let passed = 0;
  TESTS.forEach(t => {
    const ok = (() => { try { return t.fn(results); } catch(e) { return false; } })();
    if (ok) passed++;
    const item = document.createElement('div'); item.className = 'val-item';
    item.innerHTML = `
      <span class="check">${ok ? '✅' : '❌'}</span>
      <div class="label">${t.desc}</div>
      <span class="badge ${ok ? 'badge-pass' : 'badge-fail'}">${ok ? 'PASS' : 'FAIL'}</span>
    `;
    valList.appendChild(item);
    log(`${ok ? 'PASS' : 'FAIL'}: ${t.desc}`, ok ? 'ok' : 'err');
  });

  // Summary
  const counted = new Set();
  let totalElim = 0, totalAnnual = 0, totalCapital = 0;
  results.forEach(r => {
    if (r.group.ids.every(id => !counted.has(id))) {
      r.group.ids.forEach(id => counted.add(id));
      totalElim    += r.eliminable;
      totalAnnual  += r.savings.annualOp;
      totalCapital += r.savings.capital;
    }
  });

  document.getElementById('s-vehicles').textContent = VEHICLES.length;
  document.getElementById('s-trips').textContent    = totalTrips.toLocaleString();
  document.getElementById('s-pairs').textContent    = pairs.length;
  document.getElementById('s-groups').textContent   = results.length;
  document.getElementById('s-elim').textContent     = totalElim;
  document.getElementById('s-annual').textContent   = fmt(totalAnnual);
  document.getElementById('s-capital').textContent  = fmt(totalCapital);

  log(`Done — ${passed}/${TESTS.length} tests passed · ${totalElim} eliminable · ${fmt(totalAnnual)}/yr`, passed === TESTS.length ? 'ok' : 'warn');
}

main();
</script>
</body>
</html>
